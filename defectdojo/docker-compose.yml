version: '3'
services:
  postgres:
    image: postgres:13-alpine
    environment:
      - POSTGRES_USER=defectdojo
      - POSTGRES_PASSWORD=defectdojo
      - POSTGRES_DB=defectdojo
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:6-alpine

  rabbitmq:
    image: rabbitmq:3.8-alpine

  uwsgi:
    image: defectdojo/defectdojo-django:latest
    depends_on:
      - postgres
      - redis
      - rabbitmq
    environment:
      - DD_DATABASE_URL=postgres://defectdojo:defectdojo@postgres:5432/defectdojo
      - DD_CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
      - DD_DEBUG=true
      - DD_SECRET_KEY=super-secret-key-change-me
      - DD_ALLOWED_HOSTS=*
    entrypoint: ['/entrypoint-uwsgi-dev.sh']
    volumes:
      - ./media:/app/media

  celeryworker:
    image: defectdojo/defectdojo-django:latest
    depends_on:
      - postgres
      - redis
      - rabbitmq
    environment:
      - DD_DATABASE_URL=postgres://defectdojo:defectdojo@postgres:5432/defectdojo
      - DD_CELERY_BROKER_URL=amqp://guest:guest@rabbitmq:5672//
      - DD_SECRET_KEY=super-secret-key-change-me
    entrypoint: ['/entrypoint-celery-worker.sh']

  nginx:
    image: defectdojo/defectdojo-nginx:latest
    depends_on:
      - uwsgi
    ports:
      - "8080:8080"
    environment:
      - DD_UWSGI_PASS=uwsgi:3031
      - DD_UWSGI_HOST=uwsgi
      - DD_UWSGI_PORT=3031

volumes:
  postgres_data:
