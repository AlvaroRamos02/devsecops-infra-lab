name: CI - DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  sast:
    name: SAST (Semgrep)
    runs-on: self-hosted
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/src \
            returntocorp/semgrep semgrep scan \
            --config=auto \
            --json \
            --output=/src/semgrep-report.json \
            /src/app

      - name: Upload SAST Report
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: semgrep-report.json

  sca-fs:
    name: SCA Repo (Trivy FS)
    runs-on: self-hosted
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run Trivy FS
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/src \
            aquasec/trivy fs /src/app \
            --format json \
            --output /src/trivy-fs-report.json

      - name: Upload SCA FS Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-report
          path: trivy-fs-report.json

  build:
    name: Build Docker Image
    runs-on: self-hosted
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t myapp:latest .

      - name: Save Docker image
        run: |
          docker save myapp:latest -o image.tar

      - name: Upload Docker Image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar

  sca-image:
    name: SCA Image (Trivy Image)
    runs-on: self-hosted
    needs: build
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Run Trivy on Image
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image \
            --input /workspace/image.tar \
            --format json \
            --output /workspace/trivy-image-report.json

      - name: Upload SCA Image Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-image-report.json

  dashboard:
    name: Security Dashboard
    runs-on: self-hosted
    needs: [sast, sca-fs, sca-image]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download SAST Report
        uses: actions/download-artifact@v4
        with:
          name: semgrep-report
          path: dashboard/data/

      - name: Download SCA FS Report
        uses: actions/download-artifact@v4
        with:
          name: trivy-fs-report
          path: dashboard/data/

      - name: Download SCA Image Report
        uses: actions/download-artifact@v4
        with:
          name: trivy-image-report
          path: dashboard/data/

      - name: Upload Security Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: security-dashboard
          path: dashboard/

      - name: Deploy Dashboard (Local)
        run: |
          docker-compose down
          docker-compose up -d --force-recreate dashboard
