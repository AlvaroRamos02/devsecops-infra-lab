name: CI - DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  devsecops-pipeline:
    runs-on: self-hosted
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      #########################################
      # 1) SAST (Semgrep)
      #########################################
      - name: Run Semgrep (SAST)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/src \
            returntocorp/semgrep semgrep scan \
            --config=auto \
            --json \
            --output=semgrep-report.json

      - name: Upload Semgrep results to DefectDojo
        continue-on-error: true
        env:
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}
        run: |
          if [ -z "$DEFECTDOJO_ENGAGEMENT_ID" ]; then
            echo "::error::DEFECTDOJO_ENGAGEMENT_ID is not set or empty!"
          else
            echo "Subiendo Semgrep a DefectDojo..."
            curl -sS -X POST "${DEFECTDOJO_URL%/}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=Semgrep JSON Report" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
              -F "product_name=DevSecOps Lab" \
              -F "file=@semgrep-report.json" \
              -F "active=true" \
              -F "verified=false" || echo "Error al subir Semgrep."
          fi

      #########################################
      # 2) SCA a nivel de repositorio (Trivy FS)
      #########################################
      - name: Run Trivy FS scan (SCA repo)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/src \
            aquasec/trivy fs /src \
            --format json \
            --output trivy-fs-report.json

      - name: Upload Trivy FS results to DefectDojo
        continue-on-error: true
        env:
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}
        run: |
          if [ -z "$DEFECTDOJO_ENGAGEMENT_ID" ]; then
            echo "::error::DEFECTDOJO_ENGAGEMENT_ID is not set or empty!"
          else
            echo "Subiendo Trivy FS a DefectDojo..."
            curl -sS -X POST "${DEFECTDOJO_URL%/}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=Trivy Scan" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
              -F "product_name=DevSecOps Lab" \
              -F "file=@trivy-fs-report.json" \
              -F "active=true" \
              -F "verified=false" || echo "Error al subir Trivy FS."
          fi

      #########################################
      # 3) Build Docker
      #########################################
      - name: Build Docker image
        run: |
          docker build -t myapp:latest .

      - name: Save Docker image as tar
        run: |
          docker save myapp:latest -o image.tar

      #########################################
      # 4) SCA de la imagen (Trivy Image)
      #########################################
      - name: Run Trivy on Docker image
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image \
            --input /workspace/image.tar \
            --format json \
            --output /workspace/trivy-image-report.json

      - name: Upload Trivy Image results to DefectDojo
        continue-on-error: true
        env:
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}
        run: |
          if [ -z "$DEFECTDOJO_ENGAGEMENT_ID" ]; then
            echo "::error::DEFECTDOJO_ENGAGEMENT_ID is not set or empty!"
          else
            echo "Subiendo Trivy Image a DefectDojo..."
            curl -sS -X POST "${DEFECTDOJO_URL%/}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=Trivy Scan" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
              -F "product_name=DevSecOps Lab" \
              -F "file=@trivy-image-report.json" \
              -F "active=true" \
              -F "verified=false" || echo "Error al subir Trivy Image."
          fi
