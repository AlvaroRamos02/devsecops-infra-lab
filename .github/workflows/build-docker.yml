name: CI - SAST + SCA + Build Docker

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  # 1) SAST con Semgrep
  sast:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run Semgrep (SAST) and generate JSON report
        run: |
          docker run --rm -v "${PWD}:/src" returntocorp/semgrep semgrep \
            --config=p/default \
            --json \
            -o /src/semgrep_results.json \
            /src

      - name: Upload Semgrep results to DefectDojo
        continue-on-error: true
        env:
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}
        run: |
          echo "Subiendo Semgrep a DefectDojo..."
          curl -v -X POST "${DEFECTDOJO_URL%/}/api/v2/import-scan/" \
            -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
            -F "scan_type=Semgrep JSON Report" \
            -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
            -F "file=@semgrep_results.json" \
            -F "minimum_severity=Low" \
            -F "active=true" \
            -F "verified=false" || echo "No se pudo conectar a DefectDojo."

  # 2) Build de la imagen Docker (depende de SAST)
  build:
    runs-on: self-hosted
    needs: sast

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t devsecops-nginx ./docker/nginx

  # 3) SCA de la imagen con Trivy (tambi√©n depende de SAST)
  sca:
    runs-on: self-hosted
    needs: sast

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build Docker image for SCA
        run: |
          docker build -t devsecops-nginx ./docker/nginx

      - name: Run Trivy (SCA) and generate JSON report
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v "${PWD}:/work" \
            aquasec/trivy:latest image \
            --format json \
            -o /work/trivy_results.json \
            devsecops-nginx:latest

      - name: Upload Trivy results to DefectDojo
        continue-on-error: true
        env:
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}
        run: |
          echo "Subiendo Trivy a DefectDojo..."
          curl -v -X POST "${DEFECTDOJO_URL%/}/api/v2/import-scan/" \
            -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
            -F "scan_type=Trivy Scan" \
            -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
            -F "file=@trivy_results.json" \
            -F "minimum_severity=Low" \
            -F "active=true" \
            -F "verified=false" || echo "No se pudo conectar a DefectDojo."

